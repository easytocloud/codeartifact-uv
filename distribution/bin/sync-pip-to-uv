#!/bin/bash
#
# sync-pip-to-uv - Sync AWS CodeArtifact configuration from pip to uv
#
# This script monitors pip configuration and automatically updates uv configuration
# when AWS CodeArtifact login changes the pip config.
#
# All configuration is extracted from pip.conf - no hardcoded defaults.
#
# Usage:
#   1. Install this script to a location in your PATH
#   2. Run 'sync-pip-to-uv watch' in background or as a service
#   3. Or add a precmd hook to your shell (see setup-shell-hook)
#   4. Run 'aws codeartifact login --tool pip' as usual
#   5. The uv config will be automatically updated
#

set -e

# --- Configuration ---
PIPCONFIG="${HOME}/.config/pip/pip.conf"
UVCONFIGDIR="${HOME}/.config/uv"
UVCONFIG="${UVCONFIGDIR}/uv.toml"
CACHE_FILE="${UVCONFIGDIR}/.pip-to-uv-cache"

# Fallback to PyPI (can be overridden by environment variable)
ENABLE_PYPI_FALLBACK="${SYNC_PIP_TO_UV_PYPI_FALLBACK:-true}"

# --- Functions ---

# Get CodeArtifact token via AWS CLI
get_token() {
    local domain="$1"
    local domain_owner="$2"
    local region="$3"

    if [[ -z "${domain}" || -z "${domain_owner}" || -z "${region}" ]]; then
        echo "" >&2
        return 1
    fi

    aws codeartifact get-authorization-token \
        --domain "${domain}" \
        --domain-owner "${domain_owner}" \
        --region "${region}" \
        --query authorizationToken \
        --output text 2>/dev/null || echo ""
}

# Extract CodeArtifact details from pip config URL
parse_codeartifact_url() {
    local url="$1"
    local domain=""
    local domain_owner=""
    local region=""
    local repo=""

    # URL pattern: https://aws:TOKEN@DOMAIN-ACCOUNT_ID.d.codeartifact.REGION.amazonaws.com/pypi/REPO/simple/
    if [[ "${url}" =~ https://aws:.*@([^-]+)-([0-9]+)\.d\.codeartifact\.([^.]+)\.amazonaws\.com/pypi/([^/]+) ]]; then
        domain="${BASH_REMATCH[1]}"
        domain_owner="${BASH_REMATCH[2]}"
        region="${BASH_REMATCH[3]}"
        repo="${BASH_REMATCH[4]}"
    fi

    echo "${domain}|${domain_owner}|${region}|${repo}"
}

# Generate uv config from pip config
update_uv_config() {
    if [[ ! -f "${PIPCONFIG}" ]]; then
        echo "No ${PIPCONFIG} found — skipping." >&2
        return 1
    fi

    mkdir -p "${UVCONFIGDIR}"

    # Extract index-url from pip config
    local url
    url=$(grep -E '^\s*index-url\s*=' "${PIPCONFIG}" | cut -f2 -d= | xargs 2>/dev/null || echo "")

    if [[ -z "${url}" ]]; then
        echo "No index-url found in ${PIPCONFIG}" >&2
        return 1
    fi

    # Check if this is a CodeArtifact URL
    if [[ ! "${url}" =~ codeartifact.*amazonaws\.com ]]; then
        echo "Not a CodeArtifact URL, skipping" >&2
        return 1
    fi

    # Parse CodeArtifact details from URL
    local parsed
    parsed=$(parse_codeartifact_url "${url}")
    IFS='|' read -r domain domain_owner region repo <<< "${parsed}"

    if [[ -z "${domain}" || -z "${domain_owner}" || -z "${region}" || -z "${repo}" ]]; then
        echo "Failed to parse CodeArtifact URL: ${url}" >&2
        return 1
    fi

    # Get fresh token
    local token
    token=$(get_token "${domain}" "${domain_owner}" "${region}")

    if [[ -z "${token}" ]]; then
        echo "Warning: could not retrieve AWS CodeArtifact token" >&2
        echo "         Ensure AWS CLI is configured and you have access to:" >&2
        echo "         Domain: ${domain}, Account: ${domain_owner}, Region: ${region}" >&2
    fi

    # Build URLs with embedded credentials (uv format)
    local baseurl
    local simple_url
    baseurl="https://${domain}-${domain_owner}.d.codeartifact.${region}.amazonaws.com/pypi/${repo}"

    if [[ -n "${token}" ]]; then
        # Embed credentials in URL
        simple_url="https://aws:${token}@${domain}-${domain_owner}.d.codeartifact.${region}.amazonaws.com/pypi/${repo}/simple/"
    else
        # URL without credentials (will fail but shows structure)
        simple_url="https://${domain}-${domain_owner}.d.codeartifact.${region}.amazonaws.com/pypi/${repo}/simple/"
    fi

    # Build publish URL with credentials
    local publish_url_with_creds
    if [[ -n "${token}" ]]; then
        publish_url_with_creds="https://aws:${token}@${domain}-${domain_owner}.d.codeartifact.${region}.amazonaws.com/pypi/${repo}/"
    else
        publish_url_with_creds="${baseurl}/"
    fi

    # Write uv config
    {
        echo "# AWS CodeArtifact index"
        echo "# Auto-generated by sync-pip-to-uv on $(date '+%Y-%m-%d %H:%M:%S')"
        echo "# Source: ${PIPCONFIG}"
        echo "# Domain: ${domain}, Account: ${domain_owner}, Region: ${region}"
        echo ""

        # Add PyPI as fallback if enabled
        if [[ "${ENABLE_PYPI_FALLBACK}" == "true" ]]; then
            echo "# Index strategy: try all indexes until package is found"
            echo "# This allows fallback from CodeArtifact to PyPI on any error"
            echo "index-strategy = \"unsafe-first-match\""
            echo ""
        fi

        echo "# Primary index: CodeArtifact (highest priority - tried first)"
        echo "[[index]]"
        echo "name = \"${repo}\""
        echo "url = \"${simple_url}\""
        echo "publish-url = \"${publish_url_with_creds}\""

        # Add PyPI as fallback if enabled
        if [[ "${ENABLE_PYPI_FALLBACK}" == "true" ]]; then
            echo ""
            echo "# Fallback index: PyPI (tried if CodeArtifact fails)"
            echo "[[index]]"
            echo "name = \"pypi\""
            echo "url = \"https://pypi.org/simple/\""
        fi
    } > "${UVCONFIG}"

    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Updated ${UVCONFIG}" >&2
    echo "  Domain: ${domain}" >&2
    echo "  Repository: ${repo}" >&2
    echo "  Region: ${region}" >&2
    return 0
}

# Check if pip config has changed since last sync
has_pip_config_changed() {
    [[ ! -f "${CACHE_FILE}" ]] && return 0
    [[ ! -f "${PIPCONFIG}" ]] && return 1

    local current_hash
    current_hash=$(md5sum "${PIPCONFIG}" 2>/dev/null | cut -d' ' -f1 || md5 -q "${PIPCONFIG}" 2>/dev/null || echo "")

    local cached_hash
    cached_hash=$(cat "${CACHE_FILE}" 2>/dev/null || echo "")

    [[ "${current_hash}" != "${cached_hash}" ]]
}

# Update cache with current pip config hash
update_cache() {
    [[ ! -f "${PIPCONFIG}" ]] && return 1

    mkdir -p "${UVCONFIGDIR}"
    md5sum "${PIPCONFIG}" 2>/dev/null | cut -d' ' -f1 > "${CACHE_FILE}" 2>/dev/null || \
        md5 -q "${PIPCONFIG}" > "${CACHE_FILE}" 2>/dev/null || \
        return 1
}

# Watch pip config for changes using fswatch (macOS) or inotifywait (Linux)
watch_config() {
    echo "Watching ${PIPCONFIG} for changes..." >&2
    echo "Press Ctrl+C to stop" >&2

    # Ensure pip config directory exists
    local pip_config_dir
    pip_config_dir=$(dirname "${PIPCONFIG}")
    mkdir -p "${pip_config_dir}"

    # Detect available file watcher
    if command -v fswatch >/dev/null 2>&1; then
        # macOS - use fswatch
        fswatch -o "${PIPCONFIG}" | while read -r _; do
            echo "→ Detected change in ${PIPCONFIG}" >&2
            if has_pip_config_changed; then
                update_uv_config
                update_cache
            fi
        done
    elif command -v inotifywait >/dev/null 2>&1; then
        # Linux - use inotifywait
        while true; do
            inotifywait -e modify,create "${PIPCONFIG}" 2>/dev/null
            echo "→ Detected change in ${PIPCONFIG}" >&2
            if has_pip_config_changed; then
                update_uv_config
                update_cache
            fi
            sleep 1
        done
    else
        echo "Error: No file watcher available" >&2
        echo "Install fswatch (macOS) or inotify-tools (Linux)" >&2
        echo "  macOS: brew install fswatch" >&2
        echo "  Linux: apt-get install inotify-tools" >&2
        return 1
    fi
}

# Show usage information
usage() {
    cat <<EOF
sync-pip-to-uv - Sync AWS CodeArtifact configuration from pip to uv

Usage:
  sync-pip-to-uv [command]

Commands:
  sync           Sync pip config to uv config once (default)
  check          Check if pip config has changed
  watch          Watch pip config for changes and auto-sync
  setup-hook     Print shell hook code for .zshrc/.bashrc
  help           Show this help message

Environment Variables:
  SYNC_PIP_TO_UV_PYPI_FALLBACK    Enable PyPI fallback (default: true)
                                  Set to 'false' to use only CodeArtifact

How it works:
  1. Reads CodeArtifact configuration from ${PIPCONFIG}
  2. Parses domain, account ID, region, and repository from the index-url
  3. Fetches a fresh authentication token from AWS CodeArtifact
  4. Writes configuration to ${UVCONFIG}
  5. Optionally adds PyPI as fallback index (tries CodeArtifact first)

Files:
  ${PIPCONFIG}     Source pip configuration
  ${UVCONFIG}      Target uv configuration
  ${CACHE_FILE}    Cache file for change detection

Examples:
  # One-time manual sync
  sync-pip-to-uv sync

  # Watch for changes (runs in foreground)
  sync-pip-to-uv watch

  # Watch for changes in background
  sync-pip-to-uv watch &

  # Set up shell hook for automatic sync on prompt
  sync-pip-to-uv setup-hook >> ~/.zshrc

  # After AWS CodeArtifact login
  aws codeartifact login --tool pip
  # uv config will be automatically updated (if watcher or hook is active)

  # Disable PyPI fallback (CodeArtifact only)
  SYNC_PIP_TO_UV_PYPI_FALLBACK=false sync-pip-to-uv sync

Installation:
  1. Install file watcher:
     macOS:  brew install fswatch
     Linux:  apt-get install inotify-tools

  2. Choose sync method:
     a) Background watcher (recommended):
        Add to ~/.zshrc:
          sync-pip-to-uv watch > /dev/null 2>&1 &

     b) Shell hook (checks on every prompt):
        sync-pip-to-uv setup-hook >> ~/.zshrc

EOF
}

# Print shell hook code for .zshrc/.bashrc integration
# This is a lightweight alternative to the watcher
print_shell_hook() {
    cat <<'EOF'
# AWS CodeArtifact pip-to-uv auto-sync
# Checks for pip config changes before each prompt
function _sync_pip_to_uv_precmd() {
    if command -v sync-pip-to-uv >/dev/null 2>&1; then
        if sync-pip-to-uv check 2>/dev/null; then
            sync-pip-to-uv sync 2>/dev/null || true
        fi
    fi
}

# Hook into shell prompt
if [[ -n "$ZSH_VERSION" ]]; then
    # zsh
    autoload -Uz add-zsh-hook
    add-zsh-hook precmd _sync_pip_to_uv_precmd
elif [[ -n "$BASH_VERSION" ]]; then
    # bash
    PROMPT_COMMAND="_sync_pip_to_uv_precmd${PROMPT_COMMAND:+;$PROMPT_COMMAND}"
fi
EOF
}

# --- Main ---

case "${1:-sync}" in
    sync)
        if has_pip_config_changed; then
            update_uv_config
            update_cache
        else
            echo "Pip config unchanged — skipping sync" >&2
        fi
        ;;
    check)
        has_pip_config_changed
        ;;
    watch)
        watch_config
        ;;
    setup-hook)
        print_shell_hook
        ;;
    help|--help|-h)
        usage
        ;;
    *)
        echo "Unknown command: $1" >&2
        echo "Run 'sync-pip-to-uv help' for usage information" >&2
        exit 1
        ;;
esac
